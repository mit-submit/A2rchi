name: Test and Build Tag

env:
  A2RCHI_DIR: ${{ github.workspace }}/a2rchi-local
  REGISTRY_PREFIX: a2rchi

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Branch or commit to release
        required: false
        default: main
      tag_name:
        description: Tag to create (e.g. v1.2.3)
        required: true

permissions:
  contents: write

jobs:
  build-images:
    runs-on: [submit76-runner]
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      clean: ${{ steps.version.outputs.clean }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          python3 --version

      - name: Determine release version
        id: version
        run: |
          TAG="${{ inputs.tag_name }}"
          CLEAN="${TAG#v}"
          if [[ -z "$CLEAN" ]]; then
            echo "Unable to derive version from tag '$TAG'" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "clean=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Install CLI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[all]" || pip install .

      - name: Ensure build scripts are executable
        run: chmod +x scripts/dev/*.sh

      - name: Build Docker base images
        run: scripts/dev/build_docker_images.sh "${{ steps.version.outputs.tag }}"

      - name: Push versioned base images
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          PUSH_LATEST: "false"
        run: scripts/dev/push_docker_images.sh "${{ steps.version.outputs.tag }}"

  smoke-test:
    runs-on: [submit76-runner]
    needs: build-images
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python 
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          python3 --version

      - name: Install CLI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[all]" || pip install .

      - name: Ensure scripts are executable
        run: chmod +x scripts/dev/*.sh

      - name: Point Dockerfiles to versioned base images
        run: python scripts/dev/update_service_base_images.py --tag "${{ needs.build-images.outputs.tag }}" --switch-source dockerhub

      - name: Run smoke deployment
        uses: ./.github/actions/run-smoke
        with:
          deployment-name: release-${{ github.run_id }}
          extra-env: A2RCHI_COMPOSE_UP_FLAGS=--build --pull 
          config-path: tests/pr_preview_config/pr_preview_config.yaml
          config-destination: configs/ci/ci_config.yaml
          env-file: .env
          services: chatbot
          hostmode: "true"
          wait-url: http://localhost:27861/api/health
          base-url: http://localhost:27861
          use-podman: "true"

      - name: Commit Dockerfile base image updates
        if: success()
        env:
          TARGET_REF: ${{ inputs.ref || 'main' }}
          VERSION_TAG: ${{ needs.build-images.outputs.tag }}
        run: |
          set -euo pipefail
          CHANGED_FILES="$(git diff --name-only | grep -E '(^|/)Dockerfile' || true)"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Dockerfile updates to commit"
          else
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            printf '%s\n' "$CHANGED_FILES" | xargs git add
            git commit -m "chore: update Dockerfiles for ${VERSION_TAG}"
            git push origin HEAD:"${TARGET_REF}"
          fi

      - name: Prune Docker cache
        if: always()
        run: |
          docker system prune -af || true
          docker volume prune -f || true

  release:
    runs-on: [submit76-runner]
    needs: [build-images, smoke-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python (Self-hosted)
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          python3 --version

      - name: Promote Docker images to latest
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          VERSION_TAG: ${{ needs.build-images.outputs.tag }}
          REGISTRY_PREFIX: ${{ env.REGISTRY_PREFIX }}
        run: |
          set -euo pipefail
          echo "$DOCKERHUB_TOKEN" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin
          for image in ${REGISTRY_PREFIX}/a2rchi-python-base ${REGISTRY_PREFIX}/a2rchi-pytorch-base; do
            # Pull the versioned image and re-tag as latest
            docker pull "docker.io/$image:$VERSION_TAG"
            docker tag "docker.io/$image:$VERSION_TAG" "docker.io/$image:latest"
            docker push "docker.io/$image:latest"
          done
      - name: Update version in project files
        run: python scripts/dev/update_version.py "${{ needs.build-images.outputs.clean }}"
      - name: Commit version bump
        env:
          VERSION_CLEAN: ${{ needs.build-images.outputs.clean }}
          TARGET_REF: ${{ inputs.ref || 'main' }}
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "Version files already set to ${VERSION_CLEAN}"
          else
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add pyproject.toml docs/mkdocs.yml
            git commit -m "chore: bump version to ${VERSION_CLEAN}"
            git push origin HEAD:"${TARGET_REF}"
          fi

      - name: Create Git tag
        env:
          TAG_NAME: ${{ needs.build-images.outputs.tag }}
        run: |
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists locally." >&2
            exit 1
          fi
          if git ls-remote --tags origin "$TAG_NAME" | grep "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists on origin." >&2
            exit 1
          fi
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"